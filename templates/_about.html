<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<div class="w-[100%] h-[240px] mt-[-10px] pb-[30px] flex flex-col lg:flex-row z-[4]">
    <div class="w-[100%] rounded-lg min-h-auto max-h-[240px] 2xl:max-h-[150px] bg-[var(--bg-overlay)] drop-shadow-[0_0_10px_black]/20 flex flex-row justify-center items-center px-4 py-1">
        <div class="w-[34%] h-[90%] flex flex-col justify-center">
            <p class="sour-gummy text-[var(--text-color)] lg:text-2xl sm:text-xl text-lg opacity-80 text-center mx-2">Updated Daily</p>
            <p class="sour-gummy text-[var(--text-color)] lg:text-lg sm:text-md text-lg opacity-50 text-center mx-2">Automatic Refresh Every 12am</p>
        </div>
        <div class="w-[33%] h-[90%] flex flex-col justify-center">
            <p class="sour-gummy text-[var(--text-color)] lg:text-2xl sm:text-xl text-lg opacity-80 text-center mx-2">All Index Stocks</p>
            <p class="sour-gummy text-[var(--text-color)] lg:text-lg sm:text-md text-lg opacity-50 text-center mx-2">Every single major & minor stocks</p>
        </div>
        <div class="w-[33%] h-[90%] flex flex-col justify-center">
            <p class="sour-gummy text-[var(--text-color)] lg:text-2xl sm:text-xl text-lg opacity-80 text-center mx-2">45 Day Range</p>
            <p class="sour-gummy text-[var(--text-color)] lg:text-lg sm:text-md text-lg opacity-50 text-center mx-2">View all forecasts upto 45 days</p>
        </div>
    </div>
</div>

<div class="w-[100%] h-[700px] lg:h-[500px] pb-[20px] sm:-mt-[80px] lg:-mt-0 flex flex-col lg:flex-row mx-auto lg:gap-x-[30px]">
    <div class="w-[100%] lg:w-[50%] min-h-auto lg:max-h-[340px] flex flex-col order-2 lg:order-1 justify-center">
        <p class="permanent-marker text-[var(--text-colour)] text-2xl lg:text-xl 2xl:text-2xl font-[300] text-center mt-[40px] lg:mt-0">Volatility Stock Market Scanner</p>
        <p class="permanent-marker text-[var(--text-colour)] text-xl lg:text-lg 2xl:text-xl font-[300] text-center mt-[10px] lg:mt-0"><span class="opacity-60">Developed By </span>
            <span class="text-[#9000ff] cursor-pointer hover:opacity-80 transition-all ease-in duration-150" onClick="openDev()">
                AlexW03x
            </span></p>

        <p class="sour-gummy text-[var(--text-colour)] text-md font-[400] text-center mx-4 opacity-50 mt-4 break-words">
            AW Stock Options Scanner is a Python, Flask web application designed to make recommendations on different market symbols/tickers 
            using Implied Volatility vs Relative Volatility, Market Historic Data for Forecasting, Average Volume per Month and Gradient Coefficient for Directional Slope,
            to determine "most likely" ideas, however trading itself is a risk and no solutions will deliver guarantee!
        </p>
    </div>

    <div class="w-[100%] lg:w-[50%] min-h-auto flex flex-col order-1 lg:order-2">
        <canvas id="volatility_chart" aria-label="Volatility" class="min-w-[100%] h-[500px]"></canvas>
    </div>
</div>

<script>
    function openDev(){
        window.open("https://alexwalkerportfolio.vercel.app/")
    }
    const ctx = document.getElementById('volatility_chart').getContext('2d');
    let vixChart;

    async function fetchVolatility() {
        try {
        const response = await fetch("/api/get_volatility", { cache: "no-store" });
        const result = await response.json();
        const data = Array.isArray(result?.volatility_data) ? result.volatility_data : []; //check if API endpoint returns intraday, historic data if not NO RESULTS FOUND

        
        const labels = data.map(d => d.Date); //map labels into appropriate sections, dates and close price of market volatility.
        const values = data.map(d => d.Close);

        if (!vixChart) { //if chart doesn't exist create new chart to docID "volatility_chart"
            // First render
            vixChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                label: "Volatility Index (Daily)",
                data: values,
                borderColor: "#0a8c15",
                fill: false,
                pointRadius: 0,
                borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                animation: true,
                plugins: { legend: { display: true } },
                scales: {
                x: { display: false },     
                y: { ticks: { autoSkip: true } }
                }
            }
            });
        } else {
            // Update existing chart with the full dataset returned by the API
            vixChart.data.labels = labels;
            vixChart.data.datasets[0].data = values;
            vixChart.update();
        }
        } catch (err) {
        console.error("Fetch/update error:", err);
        // Silently keep the last good render
        }
    }

    // Fetch immediately and refresh every 5s
    fetchVolatility();
    setInterval(fetchVolatility, 5000);
</script>